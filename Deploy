#!/bin/bash

. Load

TargetDomain=$1

if [[ $TargetDomain == "" ]]; then 
    Error 'Domain is not provided';
    exit;
fi

ServerPath=$(cat /LocalSecrets/Deployment/$1 2>/dev/null | grep path: | cut -d ' ' -f2)

if [[ $ServerPath == "" ]]; then 
    Error 'Path is not available in the LocalSecrets';
    exit;
fi

Info Validating nginx config on server...

if [[ ! `ssh root@server7.paydardata.com test -f /etc/nginx/conf.d/$TargetDomain.conf && echo exists` ]] ; then
    Error "$TargetDomain is not hosted on server"
    exit
fi

Success "$TargetDomain.conf exists"
Divide

Info Validating server path...

if [[ ! `ssh root@server7.paydardata.com test -d $ServerPath && echo exists` ]] ; then
    Error "$ServerPath directory not exist on server"
    exit
fi

Success "$ServerPath exists"
Divide

Info Building the project...
Divide

Build

Info Project build finished
Divide

cd /Build

Info Compressing the built output
Divide

zip -r publish.zip .next/ public/ next.config.js next.js package.json

Info
Info Built output is compressed
Divide

export TargetDomain=$TargetDomain
export ServerPath=$ServerPath
envsubst < /PaydarCore/ServerLinux/Scripts/DeployerTemplate > /Build/Deployer

ssh root@server7.paydardata.com "rm -rf $ServerPath/Deployer"
ssh root@server7.paydardata.com "rm -rf $ServerPath/publish.zip"

Info Uploading started...
Divide

scp /Build/publish.zip root@server7.paydardata.com:$ServerPath
scp /Build/Deployer root@server7.paydardata.com:$ServerPath

Info Project uploaded.
Divide

Info Deploying the project...
Divide

ssh root@server7.paydardata.com "chmod 777 $ServerPath/Deployer"
ssh root@server7.paydardata.com "$ServerPath/Deployer"

Info
Info Deployment finished.

# ssh -t root@server7.paydardata.com "cd $ServerPath"
