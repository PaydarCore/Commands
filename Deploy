#!/bin/bash

. Load

TargetDomain=$1

if [[ $TargetDomain == "" ]]; then 
    Error 'Domain is not provided';
    exit;
fi

ServerPath=$(cat /LocalSecrets/Deployment/$1 2>/dev/null | grep path: | cut -d ' ' -f2)

if [[ $ServerPath == "" ]]; then 
    Error 'Path is not available in LocalSecrets';
    exit;
fi

# Divide
# Info Enter your target domain:
# read TargetDomain

# Divide
# Info Enter directory location on server:
# read ServerPath
# Divide


if [[ ! `ssh root@server7.paydardata.com test -f /etc/nginx/conf.d/$TargetDomain.conf && echo exists` ]] ; then
    Error "$TargetDomain not hosted in server"
    exit
fi

if [[ ! `ssh root@server7.paydardata.com test -d $ServerPath && echo exists` ]] ; then
    Error "$ServerPath directory not exist in server"
    exit
fi

Info Building the project...
Divide

Build

Info Project build finished.
Divide

cd /Build

Info Compressing the build version...
Divide

zip -r publish.zip .next/ public/ next.config.js next.js package.json

Info Build Compressed.
Divide

export TargetDomain=$TargetDomain
export ServerPath=$ServerPath
envsubst < /PaydarCore/ServerLinux/Scripts/DeployerTemplate > /Build/Deployer

ssh root@server7.paydardata.com "rm -rf ${ServerPath}/Deployer"
ssh root@server7.paydardata.com "rm -rf ${ServerPath}/publish.zip"

Info Publishing the project...
Info Uploading started...
Divide

scp /Build/publish.zip root@server7.paydardata.com:$ServerPath
scp /Build/Deployer root@server7.paydardata.com:$ServerPath

Info Project uploaded.
Divide

Info Deploying the project...
Divide

sleep 2
ssh root@server7.paydardata.com "chmod 777 ${ServerPath}/Deployer"
sleep 1
ssh root@server7.paydardata.com "${ServerPath}/Deployer"

Info Deployment finished.

# ssh -t root@server7.paydardata.com "cd ${ServerPath}"
